<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ZeroPoint</title>
  <link rel="stylesheet" href="/app.css" />
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="topbar">
        <div class="brand">ZEROPOINT REMOTE ACCESS CORE</div>
        <div class="pills">
          <button class="pill warn" id="adminLink" type="button">ADMIN</button>

          <button class="pill primary" id="loginBtn" type="button">LOGIN</button>
          <button class="pill primary" id="registerBtn" type="button">REGISTER</button>

          <button class="pill primary" id="accountBtn" type="button" style="display:none">MY PAGE</button>
          <button class="pill danger" id="logoutBtn" type="button" style="display:none">LOGOUT</button>

          <button class="pill" id="skipBtn" type="button">SKIP BOOT</button>
        </div>
      </div>

      <div class="main">
        <div class="hud">
          <div class="tag" id="tagLink">LINK: SYNCING</div>
          <div class="tag" id="tagAuth">AUTH: GUEST</div>
          <div class="tag" id="tagRole">ROLE: USER</div>
          <div class="tag" id="tagMode">MODE: BOOT</div>
        </div>

        <div class="term" id="term" aria-label="terminal"></div>

        <div class="cmdrow">
          <div class="prompt" id="prompt">/ $</div>
          <input class="cmd" id="cmdInput" autocomplete="off" placeholder="type: help" />
        </div>

        <small class="hint">
          Tips: type <b>help</b>. Games: <b>games</b>. Press <b>ESC</b> to skip boot. Shift+Skip = skip forever.
        </small>
      </div>
    </div>
  </div>

  <!-- Admin passcode modal (simulation) -->
  <div class="modal" id="adminLogin">
    <div class="modalBox" id="adminLoginBox">
      <div class="modalTitle">ADMIN ACCESS (SIMULATION)</div>
      <input id="adminPass" type="password" inputmode="numeric" placeholder="Passcode (6 digits)" />
      <div class="modalActions">
        <button class="btn primary" id="adminSubmit" type="button">Enter</button>
        <button class="btn" id="adminCancel" type="button">Cancel</button>
      </div>
      <div class="msg warn" style="margin-top:10px">
        This admin popup is part of the simulation UI. Real admins should use the real <b>/admin</b> page.
      </div>
    </div>
  </div>

  <!-- Simulation “admin panel” -->
  <div class="modal" id="adminPanel">
    <div class="modalBox">
      <div class="modalTitle">CONTROL ROOM (SIMULATION)</div>
      <div class="msg ok">Access granted (simulation). Type <b>help</b> in the terminal.</div>
      <div class="modalActions">
        <button class="btn" id="btnAdminClose" type="button">Close</button>
      </div>
    </div>
  </div>

<script>
(() => {
  // ===== DOM =====
  const term = document.getElementById("term");
  const cmdInput = document.getElementById("cmdInput");
  const promptEl = document.getElementById("prompt");

  const tagLink = document.getElementById("tagLink");
  const tagAuth = document.getElementById("tagAuth");
  const tagRole = document.getElementById("tagRole");
  const tagMode = document.getElementById("tagMode");

  const adminLink = document.getElementById("adminLink");
  const adminLogin = document.getElementById("adminLogin");
  const adminLoginBox = document.getElementById("adminLoginBox");
  const adminPass = document.getElementById("adminPass");
  const adminSubmit = document.getElementById("adminSubmit");
  const adminCancel = document.getElementById("adminCancel");
  const adminPanel = document.getElementById("adminPanel");
  const btnAdminClose = document.getElementById("btnAdminClose");

  const loginBtn = document.getElementById("loginBtn");
  const registerBtn = document.getElementById("registerBtn");
  const accountBtn = document.getElementById("accountBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const skipBtn = document.getElementById("skipBtn");

  // ===== state =====
  let currentUser = null;
  let bootRunning = true;
  let bootTimers = [];
  let cwd = "/";

  const adminPassword = "951212"; // simulation passcode ONLY
  const PRELOADED_FACTS = [
    "The first website went live in 1991.",
    "The Apollo Guidance Computer had less RAM than a modern calculator.",
    "The term 'bug' was popularized after a moth was found in a relay (1947).",
    "SHA-256 is a cryptographic hash function (one-way).",
    "In real security work, permission matters more than tools."
  ];

  const ASCII = {
    banner: String.raw`███████╗███████╗██████╗  ██████╗ ██████╗ ██╗███╗   ██╗████████╗
╚══███╔╝██╔════╝██╔══██╗██╔═══██╗██╔══██╗██║████╗  ██║╚══██╔══╝
  ███╔╝ █████╗  ██████╔╝██║   ██║██████╔╝██║██╔██╗ ██║   ██║
 ███╔╝  ██╔══╝  ██╔══██╗██║   ██║██╔═══╝ ██║██║╚██╗██║   ██║
███████╗███████╗██║  ██║╚██████╔╝██║     ██║██║ ╚████║   ██║
╚══════╝╚══════╝╚═╝  ╚═╝ ╚═════╝ ╚═╝     ╚═╝╚═╝  ╚═══╝   ╚═╝`,
    zero: String.raw`      ________  ________  _________
     |__  __  ||  ____  ||___   ___|
        | |   || |    | |    | |
        | |   || |____| |    | |
        |_|   ||________|    |_|`,
    lemon: String.raw`   .-.
  .'   '.
 /  .-.  \
 | (  )  |
 \  '-'  /
  '.___.'`,
    twinkle: String.raw`TWINKLE
  *  *  *
*   *   *`
  };

  const game = {
    mode: null,
    memorySeq: null,
    reactionArmed: false,
    reactionStart: 0,
    numberTarget: null,
    guessCount: 0,
    crackSecret: null,
    crackTries: 0,
  };

  // ===== utils =====
  function elLine(text, cls) {
    const d = document.createElement("div");
    d.className = "line" + (cls ? " " + cls : "");
    d.textContent = text;
    return d;
  }

  function printLine(text, cls) {
    term.appendChild(elLine(text, cls));
    term.scrollTop = term.scrollHeight;
  }

  function clearTerm() {
    term.innerHTML = "";
  }

  function sleep(ms) {
    return new Promise(r => setTimeout(r, ms));
  }

  // Minimal stubs (keeps your UI consistent)
  function sfx(){ /* no-op */ }
  function award(){ /* no-op */ }

  async function api(path, opts = {}) {
    const res = await fetch(path, {
      headers: { "Content-Type": "application/json", ...(opts.headers || {}) },
      credentials: "include",
      ...opts
    });
    const ct = res.headers.get("content-type") || "";
    const data = ct.includes("application/json") ? await res.json() : await res.text();
    if (!res.ok) {
      const msg = (data && data.error) ? data.error : ("Request failed: " + res.status);
      throw new Error(msg);
    }
    return data;
  }

  // ===== auth UI =====
  function setTags() {
    tagLink.textContent = "LINK: SYNCED";
    tagAuth.textContent = "AUTH: " + (currentUser ? currentUser.username : "GUEST");
    tagRole.textContent = "ROLE: " + (currentUser ? currentUser.role.toUpperCase() : "USER");
    tagMode.textContent = "MODE: " + (bootRunning ? "BOOT" : "SHELL");
  }

  async function syncAuthUI() {
    try {
      const data = await api("/api/auth/me", { method: "GET" });
      currentUser = data.loggedIn ? data.user : null;
    } catch {
      currentUser = null;
    }

    // Buttons
    if (currentUser) {
      loginBtn.style.display = "none";
      registerBtn.style.display = "none";
      accountBtn.style.display = "";
      logoutBtn.style.display = "";
    } else {
      loginBtn.style.display = "";
      registerBtn.style.display = "";
      accountBtn.style.display = "none";
      logoutBtn.style.display = "none";
    }

    setTags();
  }

  loginBtn.addEventListener("click", () => location.href = "/login?next=/");
  registerBtn.addEventListener("click", () => location.href = "/register?next=/");
  accountBtn.addEventListener("click", () => location.href = "/account");
  logoutBtn.addEventListener("click", async () => {
    try { await api("/api/auth/logout", { method: "POST" }); } catch {}
    await syncAuthUI();
    printLine("[AUTH] logged out.", "muted");
  });

  // ===== admin popup (simulation) =====
  function openAdminOverlay() {
    adminLogin.classList.add("visible");
    adminPass.value = "";
    setTimeout(() => adminPass.focus(), 20);
  }
  function closeAdminOverlay() {
    adminLogin.classList.remove("visible");
    adminPass.value = "";
  }

  adminLink.addEventListener("click", () => {
    // Real admins go to real /admin
    if (currentUser && currentUser.role === "admin") {
      location.href = "/admin";
      return;
    }
    openAdminOverlay();
    sfx("open");
  });

  adminCancel.addEventListener("click", closeAdminOverlay);
  adminLogin.addEventListener("click", (e) => { if (e.target === adminLogin) closeAdminOverlay(); });
  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && adminLogin.classList.contains("visible")) closeAdminOverlay();
  });

  adminSubmit.addEventListener("click", () => {
    if (adminPass.value === adminPassword) {
      closeAdminOverlay();
      adminPanel.classList.add("visible");
      award("admin", "Admin", "Opened admin panel (sim).");
    } else {
      alert("Wrong passcode.");
    }
  });

  adminPass.addEventListener("keydown", (e) => { if (e.key === "Enter") adminSubmit.click(); });
  btnAdminClose.addEventListener("click", () => adminPanel.classList.remove("visible"));
  adminPanel.addEventListener("click", (e) => { if (e.target === adminPanel) adminPanel.classList.remove("visible"); });

  // ===== boot / skip =====
  const BOOT_LINES = [
    "ZEROPOINT REMOTE ACCESS CORE",
    "TARGET: LIVE HANDSET • VECTOR: ENCRYPTED BACKDOOR • SIMULATION",
    "",
    "[OK] Tunnel online (AES-256/GCM)",
    "[AUTH] Requesting elevated scope…",
    "[OK] Privilege: ROOT / TEMP",
    "[SCAN] Client snapshot:",
    "  DEVICE : DESKTOP/OTHER",
    "  LOCALE : en-US",
    "  TZ     : browser",
    "",
    "[TIP] Type: help",
    "[TIP] Games: games (then memory/reaction/number/crack)",
    "[TIP] Secrets: this is a simulation. Be kind.",
    ""
  ];

  function cancelBootTimers() {
    bootTimers.forEach(id => clearTimeout(id));
    bootTimers = [];
  }

  function openShell() {
    bootRunning = false;
    cmdInput.disabled = false;
    cmdInput.focus();
    setTags();
  }

  async function typeBoot() {
    bootRunning = true;
    cmdInput.disabled = true;
    setTags();

    clearTerm();

    let t = 0;
    for (const line of BOOT_LINES) {
      const id = setTimeout(() => printLine(line, line.startsWith("[OK]") ? "ok" : line.startsWith("[TIP]") ? "muted" : line.startsWith("[AUTH]") ? "warn" : "dim"), t);
      bootTimers.push(id);
      t += 120;
    }
    const id2 = setTimeout(() => {
      printLine("[SHELL] Attached. Type: help", "ok");
      openShell();
    }, t + 80);
    bootTimers.push(id2);
  }

  function skipBoot(persist) {
    cancelBootTimers();
    clearTerm();
    BOOT_LINES.forEach(l => printLine(l, l.startsWith("[OK]") ? "ok" : l.startsWith("[TIP]") ? "muted" : l.startsWith("[AUTH]") ? "warn" : "dim"));
    printLine("[SHELL] Attached. Type: help", "ok");
    if (persist) localStorage.setItem("zp_skip_boot", "1");
    openShell();
  }

  skipBtn.addEventListener("click", (e) => skipBoot(e.shiftKey));
  window.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && bootRunning) skipBoot(e.shiftKey);
  });

  // ===== commands =====
  function help() {
    printLine("Commands:", "ok");
    printLine("  help, clear, exit, login, register, account, logout", "dim");
    printLine("  admin (opens admin modal if not real admin)", "dim");
    printLine("  banner, ascii <zero|lemon|twinkle|banner>", "dim");
    printLine("  facts, fact, coffee", "dim");
    printLine("  ping <target>, trace <ip>, locate", "dim");
    printLine("  encode (list), binary/unbinary, morse/unmorse, hex/unhex", "dim");
    printLine("  games, memory, recall <seq>, reaction, go, number, guess <n>, crack [1234]", "dim");
  }

  function gamesMenu() {
    printLine("[GAMES] Choose one:", "ok");
    printLine("  memory   → watch a sequence, then: recall <sequence>", "dim");
    printLine("  reaction → type: reaction (then when ready, type: go)", "dim");
    printLine("  number   → guess 1-100, then: guess <num>", "dim");
    printLine("  crack    → guess the 4-digit code (0000-9999). Example: crack 1234", "dim");
  }

  async function startMemory() {
    game.mode = "memory";
    const len = 4 + Math.floor(Math.random() * 3);
    const seq = Array.from({ length: len }, () => String(Math.floor(Math.random() * 10))).join("");
    game.memorySeq = seq;
    printLine("[MEMORY] Memorize this:", "ok");
    printLine(seq, "danger");
    await sleep(1200);
    printLine("[MEMORY] Now type: recall <sequence>", "muted");
  }

  function recallMemory(rest) {
    if (game.mode !== "memory" || !game.memorySeq) {
      printLine("No memory game running. Type: memory", "warn");
      return;
    }
    const guess = String(rest || "").trim().replace(/\s+/g, "");
    if (!guess) { printLine("Usage: recall <sequence>", "warn"); return; }
    if (guess === game.memorySeq) printLine("[MEMORY] Correct!", "ok");
    else { printLine("[MEMORY] Wrong.", "warn"); printLine("Expected: " + game.memorySeq, "dim"); }
    game.mode = null;
    game.memorySeq = null;
  }

  function startReaction() {
    game.mode = "reaction";
    game.reactionArmed = true;
    game.reactionStart = 0;
    printLine("[REACTION] Get ready… wait for NOW, then type: go", "ok");
    const delay = 900 + Math.random() * 2400;
    setTimeout(() => {
      if (!game.reactionArmed) return;
      game.reactionStart = performance.now();
      printLine("[REACTION] NOW!", "danger");
    }, delay);
  }

  function reactionGo() {
    if (game.mode !== "reaction" || !game.reactionArmed) {
      printLine("No reaction test running. Type: reaction", "warn");
      return;
    }
    if (!game.reactionStart) {
      printLine("[REACTION] Too early! Wait for NOW.", "warn");
      return;
    }
    const ms = performance.now() - game.reactionStart;
    printLine("[REACTION] " + ms.toFixed(0) + "ms", "ok");
    game.reactionArmed = false;
    game.reactionStart = 0;
    game.mode = null;
  }

  function startNumber() {
    game.mode = "number";
    game.numberTarget = 1 + Math.floor(Math.random() * 100);
    game.guessCount = 0;
    printLine("[NUMBER] I'm thinking 1-100. Type: guess <num>", "ok");
  }

  function guessNumber(arg) {
    if (game.mode !== "number" || !game.numberTarget) {
      printLine("No number game running. Type: number", "warn");
      return;
    }
    const n = Number(arg);
    if (!Number.isFinite(n)) { printLine("Usage: guess <num>", "warn"); return; }
    game.guessCount++;
    if (n === game.numberTarget) {
      printLine("[NUMBER] Correct! guesses=" + game.guessCount, "ok");
      game.mode = null;
      game.numberTarget = null;
      return;
    }
    printLine(n < game.numberTarget ? "Higher." : "Lower.", "dim");
  }

  function startCrack() {
    game.mode = "crack";
    game.crackSecret = String(Math.floor(Math.random() * 10000)).padStart(4, "0");
    game.crackTries = 0;
    printLine("[CRACK] Guess the 4-digit code (0000-9999).", "ok");
    printLine("Type: crack 1234", "dim");
  }

  function crackGuess(rest) {
    if (game.mode !== "crack" || !game.crackSecret) {
      printLine("No crack game running. Type: crack", "warn");
      return;
    }
    const guess = String(rest || "").trim();
    if (!/^\d{4}$/.test(guess)) { printLine("Usage: crack <4 digits>", "warn"); return; }
    game.crackTries++;
    if (guess === game.crackSecret) {
      printLine("[CRACK] Unlocked! tries=" + game.crackTries, "ok");
      game.mode = null;
      game.crackSecret = null;
      return;
    }
    let match = 0;
    for (let i = 0; i < 4; i++) if (guess[i] === game.crackSecret[i]) match++;
    printLine("[CRACK] no. position-matches=" + match + "/4", "warn");
  }

  function encodeList() {
    printLine("Encoders:", "ok");
    printLine("  binary <text> / unbinary <bits>", "dim");
    printLine("  morse <text> / unmorse <code>", "dim");
    printLine("  hex <text> / unhex <hex>", "dim");
  }

  function toBinary(text) {
    return Array.from(text).map(ch => ch.charCodeAt(0).toString(2).padStart(8,"0")).join(" ");
  }
  function fromBinary(bin) {
    return String(bin||"").trim().split(/\s+/).filter(Boolean).map(b => String.fromCharCode(parseInt(b,2))).join("");
  }

  const MORSE = {A:".-",B:"-...",C:"-.-.",D:"-..",E:".",F:"..-.",G:"--.",H:"....",I:"..",J:".---",K:"-.-",L:".-..",M:"--",N:"-.",O:"---",P:".--.",Q:"--.-",R:".-.",S:"...",T:"-",U:"..-",V:"...-",W:".--",X:"-..-",Y:"-.--",Z:"--..",
    0:"-----",1:".----",2:"..---",3:"...--",4:"....-",5:".....",6:"-....",7:"--...",8:"---..",9:"----."," ":"/"};
  const UNMORSE = Object.fromEntries(Object.entries(MORSE).map(([k,v])=>[v,k]));
  function toMorse(text){ return String(text||"").toUpperCase().split("").map(ch=>MORSE[ch]||"?").join(" "); }
  function fromMorse(code){ return String(code||"").trim().split(/\s+/).filter(Boolean).map(tok=>UNMORSE[tok]||"?").join("").replaceAll("/"," "); }

  function toHex(text){ return Array.from(String(text||"")).map(ch=>ch.charCodeAt(0).toString(16).padStart(2,"0")).join(" "); }
  function fromHex(hex){ return String(hex||"").trim().split(/\s+/).filter(Boolean).map(h=>String.fromCharCode(parseInt(h,16))).join(""); }

  async function ping(target) {
    const t = target || "127.0.0.1";
    printLine("[PING] " + t, "ok");
    for (let i=0;i<4;i++){
      await sleep(240 + Math.random()*220);
      const ms = (8 + Math.random()*42).toFixed(1);
      printLine("reply from " + t + ": time=" + ms + "ms ttl=64", "dim");
    }
    printLine("[PING] done.", "muted");
  }

  async function trace(ip) {
    const t = ip || "8.8.8.8";
    printLine("[TRACE] " + t, "ok");
    const hops = 4 + Math.floor(Math.random()*6);
    for (let i=1;i<=hops;i++){
      await sleep(260 + Math.random()*260);
      const ms = (12 + Math.random()*90).toFixed(0);
      const hop = `10.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}.${Math.floor(Math.random()*255)}`;
      printLine(i + "  " + hop + "  " + ms + "ms", "dim");
    }
    printLine("[TRACE] reached " + t + " (sim).", "muted");
  }

  function locate(){
    printLine("[LOCATE] (simulation — no real GPS used)", "warn");
    printLine("Location: UNKNOWN — stealth noise injected", "dim");
  }

  function coffee(){
    printLine("[COFFEE] Brewing…", "muted");
    printLine("   ( (", "dim");
    printLine("    ) )", "dim");
    printLine("  ........", "dim");
    printLine("  |      |]", "dim");
    printLine("  \\      /", "dim");
    printLine("   `----'", "dim");
    printLine("[COFFEE] Done. (simulation)", "ok");
  }

  function facts(){
    printLine("[FACTS] " + PRELOADED_FACTS.length + " loaded.", "ok");
    PRELOADED_FACTS.forEach((f,i) => printLine(String(i+1).padStart(2,"0") + ". " + f, "dim"));
  }

  function factOne(){
    const f = PRELOADED_FACTS[Math.floor(Math.random()*PRELOADED_FACTS.length)];
    printLine("[FACT]", "ok");
    printLine(f, "dim");
  }

  function banner(){ printLine(ASCII.banner, "ok"); }
  function asciiCmd(name){
    const key = String(name||"").toLowerCase();
    if (!key) { printLine("Usage: ascii <zero|lemon|twinkle|banner>", "warn"); return; }
    const art = ASCII[key];
    if (!art) { printLine("No art named: " + key, "warn"); return; }
    printLine(art, "dim");
  }

  async function doLogout(){
    if (!currentUser) { printLine("[AUTH] not logged in.", "muted"); return; }
    await api("/api/auth/logout", { method: "POST" });
    await syncAuthUI();
    printLine("[AUTH] logged out.", "muted");
  }

  async function handleCommand(raw) {
    const line = String(raw || "").trim();
    if (!line) return;

    printLine(cwd + " $ " + line, "dim");

    const parts = line.split(/\s+/);
    const cmd = (parts[0] || "").toLowerCase();
    const arg = parts[1];
    const rest = parts.slice(1).join(" ");

    // navigation/auth
    if (cmd === "login") { location.href = "/login?next=/"; return; }
    if (cmd === "register") { location.href = "/register?next=/"; return; }
    if (cmd === "account" || cmd === "mypage") { location.href = "/account"; return; }
    if (cmd === "logout") { await doLogout(); return; }

    if (cmd === "admin") {
      if (currentUser && currentUser.role === "admin") location.href = "/admin";
      else openAdminOverlay();
      return;
    }

    // basics
    if (cmd === "help") { help(); return; }
    if (cmd === "clear" || cmd === "cls") { clearTerm(); return; }
    if (cmd === "exit" || cmd === "quit") { printLine("[SHELL] closed (simulation).", "muted"); return; }

    // fun
    if (cmd === "facts") { facts(); return; }
    if (cmd === "fact") { factOne(); return; }
    if (cmd === "coffee") { coffee(); return; }

    // ascii
    if (cmd === "banner") { banner(); return; }
    if (cmd === "ascii") { asciiCmd(arg); return; }

    // network sim
    if (cmd === "ping") { await ping(rest); return; }
    if (cmd === "trace") { await trace(rest); return; }
    if (cmd === "locate") { locate(); return; }

    // encoders
    if (cmd === "encode" || cmd === "decode") { encodeList(); return; }
    if (cmd === "binary") { printLine(toBinary(rest), "dim"); return; }
    if (cmd === "unbinary") { printLine(fromBinary(rest), "dim"); return; }
    if (cmd === "morse") { printLine(toMorse(rest), "dim"); return; }
    if (cmd === "unmorse") { printLine(fromMorse(rest), "dim"); return; }
    if (cmd === "hex") { printLine(toHex(rest), "dim"); return; }
    if (cmd === "unhex") { printLine(fromHex(rest), "dim"); return; }

    // games
    if (cmd === "games") { gamesMenu(); return; }
    if (cmd === "memory") { await startMemory(); return; }
    if (cmd === "recall") { recallMemory(rest); return; }
    if (cmd === "reaction") { startReaction(); return; }
    if (cmd === "go") { reactionGo(); return; }
    if (cmd === "number") { startNumber(); return; }
    if (cmd === "guess") { guessNumber(arg); return; }
    if (cmd === "crack") { if (!arg) startCrack(); else crackGuess(arg); return; }

    printLine('Unknown command: ' + cmd + ' (type "help")', "warn");
  }

  cmdInput.addEventListener("keydown", async (e) => {
    if (e.key !== "Enter") return;
    if (cmdInput.disabled) return;
    const raw = cmdInput.value;
    cmdInput.value = "";
    try { await handleCommand(raw); } catch (err) {
      printLine("[ERROR] " + err.message, "danger");
    }
  });

  // ===== startup =====
  (async () => {
    await syncAuthUI();

    // Skip forever?
    if (localStorage.getItem("zp_skip_boot") === "1") {
      skipBoot(false);
    } else {
      typeBoot();
    }
  })();
})();
</script>
</body>
</html>
