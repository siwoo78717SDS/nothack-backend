<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Mod • ZeroPoint</title>
  <link rel="stylesheet" href="/app.css"/>
</head>
<body>
  <div class="wrap">
    <div class="panel">
      <div class="topbar">
        <div class="brand">MOD PANEL</div>
        <div class="pills">
          <a class="pill" href="/">HOME</a>
          <a class="pill" href="/account">ACCOUNT</a>
          <button class="pill danger" id="logoutBtn" type="button">LOGOUT</button>
        </div>
      </div>

      <div class="formWrap">
        <div class="card">
          <h1>Role Requests (View Only)</h1>
          <div id="meBox" class="msg" style="display:none"></div>

          <div class="row" style="margin-top:12px">
            <select class="text" id="statusSelect">
              <option value="pending">pending</option>
              <option value="approved">approved</option>
              <option value="rejected">rejected</option>
              <option value="all">all</option>
            </select>
            <button class="btn primary" id="refreshBtn" type="button">Refresh</button>
          </div>

          <div id="msg" class="msg" style="display:none"></div>
          <div class="msg warn" style="margin-top:10px">
            Mods can only view. Admin approves/rejects on /admin.
          </div>
        </div>

        <div class="card">
          <table class="table">
            <thead>
              <tr>
                <th>When</th>
                <th>User</th>
                <th>Requested</th>
                <th>Status</th>
                <th>Decision</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
(() => {
  const logoutBtn = document.getElementById("logoutBtn");
  const meBox = document.getElementById("meBox");
  const msg = document.getElementById("msg");
  const rows = document.getElementById("rows");
  const statusSelect = document.getElementById("statusSelect");
  const refreshBtn = document.getElementById("refreshBtn");

  function show(type, text) {
    msg.style.display = "";
    msg.className = "msg " + (type || "");
    msg.textContent = text;
  }

  function clearMsg() {
    msg.style.display = "none";
    msg.textContent = "";
  }

  async function getJSON(url, opts) {
    const res = await fetch(url, { credentials: "include", ...(opts||{}) });
    const data = await res.json().catch(()=> ({}));
    if (!res.ok) throw new Error(data.error || ("Request failed: " + res.status));
    return data;
  }

  async function postJSON(url, body) {
    return getJSON(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(body || {})
    });
  }

  async function init() {
    const me = await getJSON("/api/auth/me");
    if (!me.loggedIn) { location.href = "/login?next=/mod"; return; }
    if (me.user.role !== "mod" && me.user.role !== "admin") {
      show("danger", "Forbidden: mod/admin only.");
      return;
    }
    meBox.style.display = "";
    meBox.className = "msg ok";
    meBox.textContent = `Logged in as ${me.user.username} • role=${me.user.role}`;
    await refresh();
  }

  async function refresh() {
    clearMsg();
    rows.innerHTML = "";
    const status = statusSelect.value;
    const q = status === "all" ? "" : ("?status=" + encodeURIComponent(status));

    // This endpoint needs a small server.js patch (I give it below)
    const data = await getJSON("/api/mod/requests" + q);
    const list = data.requests || [];

    if (!list.length) {
      const tr = document.createElement("tr");
      tr.innerHTML = '<td colspan="6" class="muted">No requests.</td>';
      rows.appendChild(tr);
      return;
    }

    for (const r of list) {
      const tr = document.createElement("tr");
      const decision = r.decidedAt ? (r.decidedBy + " @ " + r.decidedAt) : "-";
      const reason = r.reason ? (" (" + r.reason + ")") : "";
      const statusBadge = `<span class="badge">${r.status}</span>`;

      tr.innerHTML = `
        <td>${r.createdAt}</td>
        <td>${r.usernameAtTime || r.userId}</td>
        <td>${r.requestedRole}</td>
        <td>${statusBadge}</td>
        <td>${decision}${reason}</td>
        <td><span class="muted">—</span></td>
      `;
      rows.appendChild(tr);
    }
  }

  refreshBtn.addEventListener("click", () => refresh().catch(e => show("danger", e.message)));

  logoutBtn.addEventListener("click", async () => {
    try { await postJSON("/api/auth/logout", {}); } catch {}
    location.href = "/";
  });

  init().catch(e => show("danger", e.message));
  setInterval(() => refresh().catch(()=>{}), 10000);
})();
</script>
</body>
</html>
