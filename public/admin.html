<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin</title>
  <style>
    body{margin:0;background:#02060c;color:#eaffee;font-family:ui-monospace,Consolas,monospace}
    .wrap{max-width:980px;margin:0 auto;padding:18px}
    .top{display:flex;justify-content:space-between;gap:10px;align-items:center;flex-wrap:wrap}
    .card{border:1px solid rgba(0,255,160,.35);border-radius:14px;padding:14px;background:rgba(0,0,0,.35);margin:12px 0}
    h1{margin:0 0 10px;letter-spacing:.14em;text-transform:uppercase;color:#7df3ff}
    h2{margin:0 0 10px;font-size:14px;letter-spacing:.10em;text-transform:uppercase;color:#9bffd4}
    button{padding:10px 14px;border-radius:12px;border:1px solid rgba(0,255,160,.55);background:rgba(0,0,0,.55);color:#eaffee;cursor:pointer}
    select, input{padding:10px;border-radius:10px;border:1px solid rgba(0,247,255,.22);background:rgba(0,0,0,.35);color:#eaffee;outline:none}
    .muted{opacity:.75}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .badge{display:inline-block;min-width:22px;text-align:center;padding:2px 8px;border-radius:999px;border:1px solid rgba(255,180,0,.6);background:rgba(255,180,0,.12);color:#ffd580;margin-left:8px}
    .req{border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px;margin-top:10px}
    .reqTitle{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .pill{display:inline-block;padding:2px 10px;border-radius:999px;border:1px solid rgba(0,255,160,.55);background:rgba(0,0,0,.35)}
    textarea{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,247,255,.22);background:rgba(0,0,0,.35);color:#eaffee;outline:none;margin-top:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <h1>Admin Panel <span id="pendingBadge" class="badge" style="display:none">0</span></h1>
      <div class="row">
        <button id="homeBtn">Back to Home</button>
        <button id="accountBtn">My Account</button>
        <button id="logoutBtn">Logout</button>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div class="muted">View:</div>
        <select id="filter">
          <option value="pending">Pending</option>
          <option value="approved">Approved</option>
          <option value="rejected">Rejected</option>
          <option value="all">All</option>
        </select>
        <button id="refreshBtn">Refresh</button>
        <div class="muted" id="msg"></div>
      </div>
    </div>

    <div class="card">
      <h2>Role Requests</h2>
      <div id="list" class="muted">Loading…</div>
    </div>
  </div>

<script>
  async function api(path, opts = {}) {
    const res = await fetch(path, {
      ...opts,
      headers: { "Content-Type": "application/json" },
      credentials: "include"
    });
    const data = await res.json().catch(()=>({}));
    return { res, data };
  }

  function setMsg(t){ document.getElementById("msg").textContent = t || ""; }

  document.getElementById("homeBtn").onclick = () => location.href="/";
  document.getElementById("accountBtn").onclick = () => location.href="/account";
  document.getElementById("logoutBtn").onclick = async () => {
    await api("/api/auth/logout", { method:"POST" });
    location.href="/login";
  };

  async function ensureAdmin(){
    const { data } = await api("/api/auth/me");
    if (!data.loggedIn) { location.href="/login"; return false; }
    if (!data.user || data.user.role !== "admin") {
      document.body.innerHTML = "<div style='padding:20px;font-family:ui-monospace,Consolas,monospace'>Forbidden</div>";
      return false;
    }
    return true;
  }

  function fmt(ts){ return ts ? new Date(ts).toLocaleString() : ""; }

  async function loadPendingCount(){
    const { res, data } = await api("/api/admin/role-requests/pending-count");
    if (!res.ok) return;
    const n = Number(data.pendingCount || 0);
    const badge = document.getElementById("pendingBadge");
    if (n > 0) { badge.style.display="inline-block"; badge.textContent=String(n); }
    else { badge.style.display="none"; }
  }

  async function loadRequests(){
    const status = document.getElementById("filter").value;
    setMsg("…");
    const { res, data } = await api("/api/admin/role-requests?status=" + encodeURIComponent(status));
    if (!res.ok) { setMsg(data.error || data.message || "Failed"); return; }
    setMsg("");

    const list = document.getElementById("list");
    const reqs = data.requests || [];
    if (!reqs.length) { list.textContent = "(none)"; return; }

    list.innerHTML = "";
    reqs.forEach(r => {
      const div = document.createElement("div");
      div.className = "req";

      const userLine = `${r.user.fullName} (@${r.user.username})`;
      const title = document.createElement("div");
      title.className = "reqTitle";
      title.innerHTML = `
        <div>
          <b>${userLine}</b>
          <div class="muted" style="margin-top:6px">Request: <span class="pill">${r.fromRole} -> ${r.toRole}</span> • status: <b>${r.status}</b></div>
          <div class="muted" style="margin-top:6px">Created: ${fmt(r.createdAt)} ${r.decidedAt ? ("• Decided: "+fmt(r.decidedAt)) : ""}</div>
        </div>
      `;
      div.appendChild(title);

      if (r.reason) {
        const pre = document.createElement("div");
        pre.className = "muted";
        pre.style.marginTop = "10px";
        pre.textContent = "Reason: " + r.reason;
        div.appendChild(pre);
      }

      if (r.status === "pending") {
        const note = document.createElement("textarea");
        note.placeholder = "Optional note to the user (shown in history)";
        note.rows = 2;

        const actions = document.createElement("div");
        actions.className = "row";
        actions.style.marginTop = "10px";
        actions.innerHTML = `
          <button class="approve">Approve</button>
          <button class="reject" style="border-color:rgba(255,76,76,.7)">Reject</button>
        `;
        div.appendChild(note);
        div.appendChild(actions);

        actions.querySelector(".approve").onclick = async () => {
          await decide(r.id, "approve", note.value.trim());
        };
        actions.querySelector(".reject").onclick = async () => {
          await decide(r.id, "reject", note.value.trim());
        };
      } else if (r.decisionNote) {
        const dn = document.createElement("div");
        dn.className = "muted";
        dn.style.marginTop = "10px";
        dn.textContent = "Decision note: " + r.decisionNote;
        div.appendChild(dn);
      }

      list.appendChild(div);
    });
  }

  async function decide(id, decision, note){
    setMsg("Saving…");
    const { res, data } = await api("/api/admin/role-requests/" + encodeURIComponent(id) + "/decide", {
      method:"POST",
      body: JSON.stringify({ decision, note })
    });
    if (!res.ok) { setMsg(data.error || data.message || "Failed"); return; }
    setMsg("Saved.");
    await loadPendingCount();
    await loadRequests();
    setTimeout(()=>setMsg(""), 900);
  }

  document.getElementById("refreshBtn").onclick = async () => {
    await loadPendingCount();
    await loadRequests();
  };

  document.getElementById("filter").onchange = loadRequests;

  (async function init(){
    const ok = await ensureAdmin();
    if (!ok) return;
    await loadPendingCount();
    await loadRequests();

    // Auto-refresh badge & list every 10 seconds
    setInterval(async () => {
      await loadPendingCount();
      if (document.getElementById("filter").value === "pending") {
        await loadRequests();
      }
    }, 10000);
  })();
</script>
</body>
</html>
